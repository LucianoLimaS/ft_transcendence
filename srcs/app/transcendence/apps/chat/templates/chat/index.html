{% extends "boilerplate_base.html" %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="chat-container">
    <div class="user-list">
        <h3>Usuários Conectados</h3>
        <ul>
            <!-- Exemplo de usuários, substitua por conteúdo dinâmico -->
            <li>User1</li>
            <li>User2</li>
            <li>User3</li>
        </ul>
    </div>
    <div class="chat-area">
        <div id="chat-messages" style="background-color: #e9ecef; padding: 10px; border: 1px solid #ccc; overflow-y: auto; height: 80vh;">
            <!-- As mensagens do chat aparecerão aqui -->
        </div>
        <form id="chat-form">
            <div class="form-group">
                <input id="message" name="message" type="text" class="form-control" placeholder="Digite sua mensagem aqui..." required />
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Enviar</button>
            </div>
        </form>
    </div>
</div>

<style>
    .chat-container {
        display: flex;
        height: 100vh;
    }
    .user-list {
        width: 20%;
        border-right: 1px solid #ccc;
        padding: 10px;
        background-color: #f8f9fa;
    }
    .chat-area {
        width: 80%;
        padding: 10px;
        display: flex;
        flex-direction: column;
        background-color: #ffffff;
    }
    #chat-messages {
        flex-grow: 1;
        border: 1px solid #ccc;
        padding: 10px;
        overflow-y: auto;
        background-color: #e9ecef;
    }
    #chat-form {
        display: flex;
        flex-direction: column;
    }
</style>

<script>
    // Função para obter o valor de um cookie específico
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const username = '{{ user.username }}';  // Nome do usuário autenticado
    const chatSocket = new WebSocket('ws://localhost:8001/ws/chat/');
    const csrfToken = getCookie('csrftoken');  // Obtém o token CSRF usando a função getCookie

    chatSocket.onopen = function(e) {
        console.log('Conexão estabelecida com sucesso!');
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('Mensagem recebida:', data.message); // Log de depuração
        const chatMessages = document.getElementById('chat-messages');
        const messageElement = document.createElement('div');
        messageElement.textContent = `${data.username}: ${data.message}`; // Exibe o nome do usuário
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Rolagem automática
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket fechado inesperadamente');
    };

    document.getElementById('chat-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInput = document.getElementById('message');
        const message = messageInput.value;
        console.log('Enviando mensagem:', message); // Log de depuração
        chatSocket.send(JSON.stringify({
            'message': message,
            'username': username // Incluindo o nome do usuário na mensagem
        }));
        messageInput.value = '';
    };
</script>
{% endblock %}
