<html>

<head>
    <meta charset="UTF-8">
    <title>Pong Cl√°ssico</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000;
            font-family: 'Press Start 2P', cursive;
        }

        #gameCanvas {
            border: 2px solid #fff;
        }

        #countdown {
            position: absolute;
            color: #fff;
            font-size: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .players {
            color: #fff;
            display: flex;
            justify-content: space-between;
            width: 800px;
            margin-bottom: 20px;
        }

        #winner {
            position: absolute;
            color: #fff;
            font-size: 32px;
            text-align: center;
            display: none;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border: 2px solid #fff;
        }
    </style>
</head>

<body>
    <div class="players">
        <div><span class="p1">Player 1</span>: <span id="p1Lives">üêÑüêÑüêÑ</span></div>
        <div><span class="p2">Player 2</span>: <span id="p2Lives">üêÑüêÑüêÑ</span></div>
    </div>
    <div id="countdown"></div>
    <div id="winner"></div>
    <canvas id="gameCanvas" width="800" height="400"></canvas>

    <script>
        let playerNum = null; // Inicialize playerNum como null
        let websocket = new WebSocket('ws://localhost:8001/ws/pong/');

        let ballSpeedMultiplier = 1;
        let resetCountdown = 3;
        let isResetting = false;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const countdownElement = document.getElementById('countdown');
        const winnerElement = document.getElementById('winner');
        const p1LivesElement = document.getElementById('p1Lives');
        const p2LivesElement = document.getElementById('p2Lives');

        let waitingMessage = document.createElement('div');
        waitingMessage.id = 'waitingMessage';
        waitingMessage.textContent = 'Aguardando jogador...';
        waitingMessage.style.position = 'absolute'; // ou a posi√ß√£o que voc√™ preferir
        waitingMessage.style.color = 'white';      // estilo da mensagem
        document.body.appendChild(waitingMessage);

        let gameStarted = false;
        let gameEnded = false;
        let countdown = 3;

        const maxScore = 3;

        let leftScore = 0;
        let rightScore = 0;

        // Game objects
        const ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 10,
            speedX: 5,
            speedY: 5
        };

        const paddleHeight = 100;
        const paddleWidth = 10;

        const leftPaddle = {
            x: 0,
            y: canvas.height / 2 - paddleHeight / 2
        };

        const rightPaddle = {
            x: canvas.width - paddleWidth,
            y: canvas.height / 2 - paddleHeight / 2
        };

        // Controle de teclado (apenas para o paddle deste cliente)
        const keys = {};

        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        websocket.onmessage = function (event) {

            let data = JSON.parse(event.data);
            //console.log("Mensagem recebida do servidor:", event.data);
            if (data.type === "waiting_for_player") {
                // A mensagem j√° foi adicionada ao HTML no onopen, ent√£o n√£o fa√ßa nada aqui
            } else if (data.type === "player_joined") {
                waitingMessage.remove(); // Remove a mensagem quando o segundo jogador entra
            }
            if (data.type === "game_state_update") {
                ball.x = data.ball_x;
                ball.y = data.ball_y;
                leftPaddle.y = data.left_paddle_y;
                rightPaddle.y = data.right_paddle_y;
                leftScore = data.left_score;
                rightScore = data.right_score;

                updateLives(); // Atualiza a exibi√ß√£o das vidas
                checkWinner(); // Verifica se h√° um vencedor

            } else if (data.type == "game_start") {
                startCountdown();
                // Define o n√∫mero do jogador quando o jogo come√ßa (voc√™ pode receber isso do servidor tamb√©m)
                if (playerNum === null) { // Garante que o playerNum seja definido apenas uma vez
                    playerNum = data.player_num;
                    document.querySelector('.p1').textContent = data.player1_name;
                    document.querySelector('.p2').textContent = data.player2_name;
                }
            } else if (data.type === "game_state_update") {
                ball.x = data.ball_x;
                ball.y = data.ball_y;
                leftPaddle.y = data.left_paddle_y; // Atualiza a palheta esquerda
                rightPaddle.y = data.right_paddle_y; // Atualiza a palheta direita
                leftScore = data.left_score;
                rightScore = data.right_score;
                updateLives();
            } else if (data.type === "start_countdown") {
                leftScore = data.left_score;
                rightScore = data.right_score;
                updateLives(); // Atualiza a exibi√ß√£o das vidas

                startCountdown(); // Inicia a contagem regressiva antes de reiniciar o jogo
            }
        };

        function startCountdown() {
            console.log("Iniciando contagem regressiva...");
            gameStarted = false; // Pausa o jogo
            countdown = 3;
            countdownElement.style.display = "flex";
            countdownElement.textContent = countdown;

            if (checkWinner()) {
                countdownElement.style.display = "none";
                return;
            }

            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    countdownElement.style.display = "none";
                    gameStarted = true; // Reinicia o jogo
                    isResetting = false; // Permite movimenta√ß√£o

                    // Reseta a bola para o centro
                    ball.x = canvas.width / 2;
                    ball.y = Math.random() * (canvas.height - 2 * ball.radius) + ball.radius;
                    ball.speedX = (Math.random() > 0.5 ? 1 : -1) * 5 * ballSpeedMultiplier;
                    ball.speedY = (Math.random() > 0.5 ? 1 : -1) * Math.max(1, ballSpeedMultiplier);

                    if (checkWinner()) {
                        gameStarted = false; // Para o jogo se houver um vencedor
                    }
                    if(gameStarted){
                        gameLoop();
                    }
                }
            }, 1000);
        }


        function updateLives() {
            const remainingLivesP1 = 'üêÑ'.repeat(maxScore - rightScore);
            const remainingLivesP2 = 'üêÑ'.repeat(maxScore - leftScore);
            p1LivesElement.textContent = remainingLivesP1;
            p2LivesElement.textContent = remainingLivesP2;
        }

        function checkWinner() {
            if (leftScore >= maxScore) {
                gameEnded = true;
                winnerElement.style.display = 'block';
                winnerElement.textContent = 'Player 1 Venceu! üèÜ';
                return true;
            } else if (rightScore >= maxScore) {
                gameEnded = true;
                winnerElement.style.display = 'block';
                winnerElement.textContent = 'Player 2 Venceu! üèÜ';
                return true;
            }
            return false;
        }

        function movePaddles() {
            if (playerNum === 1) {
                if (keys['KeyW'] && leftPaddle.y > 0) {
                    leftPaddle.y -= 5;
                }
                if (keys['KeyS'] && leftPaddle.y < canvas.height - paddleHeight) {
                    leftPaddle.y += 5;
                }
            } else if (playerNum === 2) {
                if (keys['ArrowUp'] && rightPaddle.y > 0) {
                    rightPaddle.y -= 5;
                }
                if (keys['ArrowDown'] && rightPaddle.y < canvas.height - paddleHeight) {
                    rightPaddle.y += 5;
                }
            }


        }

        function moveBall() {
            if (!gameStarted || isResetting) return; // Pausa a bola durante o reset

            if (!gameStarted) return;

            ball.x += ball.speedX * ballSpeedMultiplier; // Aplica o multiplicador √† velocidade
            ball.y += ball.speedY * ballSpeedMultiplier;

            // Top and bottom collision
            if (ball.y + ball.radius > canvas.height || ball.y - ball.radius < 0) {
                ball.speedY = -ball.speedY;
            }

            // Paddle collision
            if (
                (ball.x - ball.radius < leftPaddle.x + paddleWidth && ball.y > leftPaddle.y && ball.y < leftPaddle.y + paddleHeight) ||
                (ball.x + ball.radius > rightPaddle.x && ball.y > rightPaddle.y && ball.y < rightPaddle.y + paddleHeight)
            ) {
                ball.speedX = -ball.speedX;
            }

            // Score
            if (ball.x + ball.radius > canvas.width) {
                leftScore++;
                if (ballSpeedMultiplier <= 3) {
                    ballSpeedMultiplier += 0.25; // aumenta a velocidade ao marcar ponto
                }
                resetBall();
            } else if (ball.x - ball.radius < 0) {
                rightScore++;
                if (ballSpeedMultiplier <= 3) {
                    ballSpeedMultiplier += 0.25; // aumenta a velocidade ao marcar ponto
                }
                resetBall();
            }
            console.log(ballSpeedMultiplier);
        }

        function resetBall() {
            console.log("Resetando bola...");
            isResetting = true; // Inicia o reset
            gameStarted = false; // Para o jogo durante o reset
            countdown = 3; // Reinicia a contagem regressiva

            countdownElement.style.display = "flex"; // Mostra o elemento de contagem regressiva
            countdownElement.textContent = countdown; // Define o texto inicial

            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    countdownElement.style.display = 'none';
                    isResetting = false;
                    gameStarted = true; // Reinicia o jogo ap√≥s a contagem regressiva

                    // Reseta posi√ß√£o da bola e sua velocidade
                    ball.x = canvas.width / 2;
                    ball.y = Math.random() * (canvas.height - 2 * ball.radius) + ball.radius;
                    ball.speedX = (Math.random() > 0.5 ? 1 : -1) * 5 * ballSpeedMultiplier;

                    let minimumSpeedY = 1;
                    let calculatedSpeedY = ballSpeedMultiplier;
                    ball.speedY = (Math.random() > 0.5 ? 1 : -1) * Math.max(minimumSpeedY, calculatedSpeedY);

                    if (checkWinner()) {
                        gameStarted = false; // Para o jogo se houver um vencedor
                    }
                }
            }, 1000);

            updateLives();
        }



        function draw() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw paddles
            ctx.fillStyle = '#fff';
            ctx.fillRect(leftPaddle.x, leftPaddle.y, paddleWidth, paddleHeight);
            ctx.fillRect(rightPaddle.x, rightPaddle.y, paddleWidth, paddleHeight);

            // Draw ball
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fill();

            // Draw center line
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
        }

        websocket.onopen = function (event) {
            console.log("Conex√£o WebSocket aberta.");
            websocket.send(JSON.stringify({ "action": "join_game" })); // Envie join_game no onopen
        };

        function gameLoop() {
            console.log("PlayerNum: ", playerNum);
            if (gameStarted && !gameEnded && playerNum !== null && !isResetting) {
                movePaddles();
                draw();

                // Envia a posi√ß√£o do paddle correspondente ao jogador
                let message = {
                    "action": "update_game_state"
                };
                if (playerNum === 1) {
                    message.left_paddle_y = leftPaddle.y;
                } else if (playerNum === 2) {
                    message.right_paddle_y = rightPaddle.y;
                }

                websocket.send(JSON.stringify(message));

            }
            requestAnimationFrame(gameLoop);
        }


        window.addEventListener('beforeunload', function () {
            websocket.send(JSON.stringify({ "action": "leave_game" }));
        });
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</body>

</html>